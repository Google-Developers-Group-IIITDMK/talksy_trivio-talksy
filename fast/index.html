<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice AI Bot</title>
<style>
body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
#status { font-weight: bold; margin-bottom: 10px; }
</style>
</head>
<body>
<h2>Speak to AI Bot (Say "quit" to end)</h2>
<div id="status">Listening...</div>

<script>
let recognition, finalTranscript = "";
const statusEl = document.getElementById('status');

if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert("Your browser does not support Speech Recognition");
} else {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-IN';

    let timeout;

    recognition.onresult = (event) => {
        let interim = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript + ' ';
            } else {
                interim += event.results[i][0].transcript;
            }
        }

        clearTimeout(timeout);
        timeout = setTimeout(() => {
            if(finalTranscript.trim() !== '') {
                processSpeech(finalTranscript.trim());
                finalTranscript = "";
            }
        }, 3000); // 3 sec silence triggers processing
    }

    recognition.onend = () => recognition.start();
    recognition.start();
}

async function processSpeech(text) {
    statusEl.innerText = "Processing...";
    if(text.toLowerCase().includes("quit")) {
        statusEl.innerText = "Conversation ended.";
        recognition.stop();
        return;
    }

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text})
        });
        const data = await res.json();

        // Play TTS
        const audio = new Audio(window.location.origin + data.tts_url);
        audio.play();

        statusEl.innerText = "Listening...";
    } catch (err) {
        console.error(err);
        statusEl.innerText = "Error! Try again.";
    }
}
</script>
</body>
</html>
